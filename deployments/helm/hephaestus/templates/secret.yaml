apiVersion: v1
kind: Secret
metadata:
  name: {{ include "hephaestus.configSecretName" . }}
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
type: Opaque
stringData:
  config.yaml: |
    buildkit:
      namespace: {{ .Release.Namespace }}
      daemonPort: {{ .Values.buildkit.service.port }}
      serviceName: {{ include "common.names.fullname" .Subcharts.buildkit }}
      statefulSetName: {{ include "common.names.fullname" .Subcharts.buildkit }}
      caCertPath: /etc/hephaestus/x509/ca.crt
      certPath: /etc/hephaestus/x509/tls.crt
      keyPath: /etc/hephaestus/x509/tls.key
      podLabels:
        {{- include "common.labels.matchLabels" .Subcharts.buildkit | nindent 8 }}
    {{- with .Values.config }}
    imageBuildMaxConcurrency: {{ .imageBuildMaxConcurrency }}
    manager:
      healthProbeAddr: ":{{ .healthProbePort }}"
      metricsAddr: ":{{ .metricsPort }}"
      webhookPort: {{ .webhookPort }}
      watchNamespaces: {{ .watchNamespaces }}
      enabledLeaderElection: {{ gt ($.Values.replicaCount | int) 1 }}
    logging:
      development: {{ .logDevelopmentMode }}
      encoder: {{ .logEncoder | quote }}
      logLevel: {{ .logLevel | quote }}
      stacktraceLevel: {{ .logStacktraceLevel | quote }}
    messaging:
      {{- with .messaging }}
      enabled: {{ .enabled }}
      amqp:
        url: {{ .amqp.url }}
        exchange: {{ .amqp.exchange | quote }}
        queue: {{ .amqp.queue | quote }}
      kafka: {{ .kafka | toYaml }}
      {{- end }}
    {{- end }}
