apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "common.names.fullname" . }}
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
data:
  config.yaml: |
    buildkit:
      labels:
        {{- include "common.labels.matchLabels" .Subcharts.buildkitd | nindent 8 }}
      namespace: {{ .Release.Namespace }}
      daemonPort: {{ .Values.buildkitd.service.port }}
    {{- with .Values.config }}
    imageBuildMaxConcurrency: {{ .imageBuildMaxConcurrency }}
    manager:
      healthProbeAddr: ":{{ .healthProbePort }}"
      metricsAddr: ":{{ .metricsPort }}"
      webhookPort: {{ .webhookPort }}
      watchNamespaces: {{ .watchNamespaces }}
      enabledLeaderElection: {{ gt ($.Values.replicaCount | int) 1 }}
    logging:
      development: {{ .logDevelopmentMode }}
      encoder: {{ .logEncoder | quote }}
      logLevel: {{ .logLevel | quote }}
      stacktraceLevel: {{ .logStacktraceLevel | quote }}
    messaging:
      {{- with .messaging }}
      enabled: {{ .enabled }}
      amqp:
        url: {{ .amqp.url }}
        exchange: {{ .amqp.exchange | quote }}
        queue: {{ .amqp.queue | quote }}
      kafka: {{ .kafka | toYaml }}
      {{- end }}
    {{- end }}
